<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SigSentry Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chart-container { height: 300px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>SigSentry Dashboard</h1>
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total Wi-Fi Devices</h5>
                        <p class="card-text" id="total-wifi"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total Bluetooth Devices</h5>
                        <p class="card-text" id="total-bluetooth"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Wi-Fi Devices (24h)</h5>
                        <p class="card-text" id="wifi-24h"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Bluetooth Devices (24h)</h5>
                        <p class="card-text" id="bluetooth-24h"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Top 5 Wi-Fi SSIDs</h5>
                        <div class="chart-container">
                            <canvas id="ssidChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Top 5 Bluetooth Device Names</h5>
                        <div class="chart-container">
                            <canvas id="btChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Recent Probe Requests</h5>
                        <div id="probes-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Suspicious Activity</h5>
                        <div id="suspicious-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Device Details</h5>
                        <select id="device-select" class="form-select mb-3">
                            <option value="">Select a device</option>
                        </select>
                        <div id="device-details"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateStats() {
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-wifi').textContent = data.total_wifi;
                    document.getElementById('total-bluetooth').textContent = data.total_bluetooth;
                    document.getElementById('wifi-24h').textContent = data.wifi_24h;
                    document.getElementById('bluetooth-24h').textContent = data.bluetooth_24h;

                    updateChart('ssidChart', 'Top 5 Wi-Fi SSIDs', data.top_ssids);
                    updateChart('btChart', 'Top 5 Bluetooth Device Names', data.top_bt_names);
                });
        }

        function updateChart(chartId, label, data) {
            const ctx = document.getElementById(chartId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.ssid || item.name),
                    datasets: [{
                        label: label,
                        data: data.map(item => item.count),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateProbes() {
            fetch('/probes')
                .then(response => response.json())
                .then(data => {
                    const probesList = document.getElementById('probes-list');
                    probesList.innerHTML = data.map(probe => `
                        <div>
                            <strong>SSID:</strong> ${probe.ssid || 'N/A'},
                            <strong>BSSID:</strong> ${probe.bssid},
                            <strong>Strength:</strong> ${probe.signal_strength},
                            <strong>Time:</strong> ${new Date(probe.timestamp).toLocaleString()}
                        </div>
                    `).join('');
                });
        }

        function updateSuspicious() {
            fetch('/suspicious')
                .then(response => response.json())
                .then(data => {
                    const suspiciousList = document.getElementById('suspicious-list');
                    suspiciousList.innerHTML = `
                        <h6>Suspicious Wi-Fi Activity:</h6>
                        ${data.suspicious_wifi.map(device => `
                            <div>
                                <strong>BSSID:</strong> ${device.bssid},
                                <strong>Count:</strong> ${device.count}
                            </div>
                        `).join('')}
                        <h6 class="mt-3">Suspicious Bluetooth Activity:</h6>
                        ${data.suspicious_bt.map(device => `
                            <div>
                                <strong>Address:</strong> ${device.address},
                                <strong>Name:</strong> ${device.name || 'N/A'},
                                <strong>RSSI:</strong> ${device.rssi},
                                <strong>Time:</strong> ${new Date(device.timestamp).toLocaleString()}
                            </div>
                        `).join('')}
                    `;
                });
        }

        function updateDeviceList() {
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    const deviceSelect = document.getElementById('device-select');
                    deviceSelect.innerHTML = '<option value="">Select a device</option>';
                    data.top_ssids.forEach(ssid => {
                        deviceSelect.innerHTML += `<option value="wifi_${ssid.ssid}">${ssid.ssid} (Wi-Fi)</option>`;
                    });
                    data.top_bt_names.forEach(bt => {
                        deviceSelect.innerHTML += `<option value="bt_${bt.name}">${bt.name} (Bluetooth)</option>`;
                    });
                });
        }

        document.getElementById('device-select').addEventListener('change', function() {
            const [type, id] = this.value.split('_');
            fetch(`/device_details?id=${id}&type=${type}`)
                .then(response => response.json())
                .then(data => {
                    const detailsDiv = document.getElementById('device-details');
                    detailsDiv.innerHTML = data.map(detail => `
                        <div>
                            ${Object.entries(detail).map(([key, value]) => `<strong>${key}:</strong> ${value}`).join(', ')}
                        </div>
                    `).join('<hr>');
                });
        });

        updateStats();
        updateProbes();
        updateSuspicious();
        updateDeviceList();
        setInterval(updateStats, 60000);
        setInterval(updateProbes, 30000);
        setInterval(updateSuspicious, 30000);
        setInterval(updateDeviceList, 60000);
    </script>
</body>
</html>
